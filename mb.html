<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advanced Budget Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --green:#10b981;
    --red:#ef4444;
    --gray:#f3f4f6;
    --dark:#111827;
    --primary:#4f46e5;
    --bg:white;
    --text:#111827;
  }
  body.dark{
    --bg:#0f0f13;
    --text:#e5e5e5;
    --gray:#1a1a1f;
  }
  body{font-family:system-ui, sans-serif; margin:0; background:var(--bg); color:var(--text); transition:.3s;background:var(--bg);} 
  h1{text-align:center; margin:.5em 0 .2em; font-size:1.8rem;font-weight:700;}
  .container{padding:1rem; max-width:1300px; margin:auto;} 
  .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:1rem;}
  .controls{display:flex;gap:.5rem;flex-wrap:wrap;}
  button, select{
    background:var(--primary);
    color:#fff;
    border:none;border-radius:.4rem;
    padding:.45rem .9rem;
    cursor:pointer;font-size:1rem;
    transition:background .2s;
  }
  button:hover{background:#4338ca;}
  .toggle-dark{background:#222;border:1px solid #555;}

  .table-wrapper{overflow-x:auto; background:var(--gray); box-shadow:0 2px 8px rgba(0,0,0,.15); border-radius:.5rem;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:.6rem .45rem;font-size:.9rem;text-align:right;border:1px solid #e5e7eb;min-width:78px; white-space:nowrap;} 
  th{background:var(--primary);color:#fff;position:sticky;top:0;z-index:2}
  td input{width:100%;border:none;text-align:right;font-size:.9rem;padding:.25rem;background:transparent}
  td input:focus{outline:2px solid var(--primary)}
  .cat td{background:#dbeafe;font-weight:600;text-align:left} 
  .total td{font-weight:600; background:#f7f8fa;}
  .net td{font-weight:700; background:#e0f7fa;} 
  .net-pos{color:var(--green)}
  .net-neg{color:var(--red)}
  .col-label{text-align:left !important;cursor:grab;}
  .col-label:active{cursor:grabbing;}

  .add-row{margin-top:.7rem;display:flex;gap:.5rem;}
  .charts{margin-top:2rem;}
  canvas{max-width:100%;background:#fff;border-radius:.5rem;padding:1rem;}

</style>
</head>
<body>

<div class="container">
  <div class="top-bar">
    <h1>Advanced Budget & Net-Profit Manager</h1>
    <button class="toggle-dark" id="darkToggle">ðŸŒ™</button>
  </div>

  <div class="controls">
    <button id="prevBtn">â€¹ Prev</button>
    <select id="yearSel"></select>
    <button id="nextBtn">Next â€º</button>
    <button id="addCategory">+ Add Category</button>
    <button id="exportBtn">Export CSV</button>
    <button id="importBtn">Import CSV</button>
    <input type="file" id="importFile" accept=".csv" hidden />
  </div>

  <div class="table-wrapper">
    <table id="budgetTable">
      <thead>
        <tr>
          <th class="col-label">Category / Line</th>
          <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
          <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
          <th>Year Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="charts">
    <h2>Charts</h2>
    <canvas id="incomeChart"></canvas>
    <canvas id="expenseChart"></canvas>
    <canvas id="netChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let debounceTimer=null;
const DEBOUNCE_DELAY=400;

let currentYear=new Date().getFullYear();
const STORAGE_KEY='budgetDataPro';
let db=loadAll();

const tbody=document.querySelector('#budgetTable tbody');
const yearSel=document.getElementById('yearSel');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const addCategory=document.getElementById('addCategory');
const exportBtn=document.getElementById('exportBtn');
const importBtn=document.getElementById('importBtn');
const importFile=document.getElementById('importFile');
const darkToggle=document.getElementById('darkToggle');

const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let defaultRows=[
  {id:'inc_total', type:'total', name:'TOTAL INCOME', totalOf:[]},
  {id:'exp_total', type:'total', name:'TOTAL EXPENSES', totalOf:[]},
  {id:'net', type:'net', name:'NET PROFIT / (LOSS)', netOf:['inc_total','exp_total']}
];

function init(){
  fillYearSelect();
  renderTable();

  prevBtn.onclick=()=>changeYear(-1);
  nextBtn.onclick=()=>changeYear(1);
  yearSel.onchange=e=>{currentYear=+e.target.value;renderTable();};
  addCategory.onclick=addCustomCategory;
  exportBtn.onclick=exportCSV;
  importBtn.onclick=()=>importFile.click();
  importFile.onchange=handleImport;
  darkToggle.onclick=toggleDark;
}

function toggleDark(){document.body.classList.toggle('dark');}

function fillYearSelect(){
  let base=new Date().getFullYear();
  for(let y=base-10;y<=base+10;y++){
    const opt=document.createElement('option');opt.value=y;opt.textContent=y;
    if(y===base) opt.selected=true;
    yearSel.appendChild(opt);
  }
}

function getRows(){
  if(!db.rows) db.rows=[];
  return [...db.rows, ...defaultRows];
}

function addCustomCategory(){
  const name=prompt("Enter category name:");
  if(!name) return;
  const id='custom_'+Date.now();
  db.rows=db.rows||[];
  db.rows.push({id,type:'item',name});
  saveAll();renderTable();
}

function changeYear(dir){
  let ny=currentYear+dir;
  if(yearSel.querySelector(`option[value="${ny}"]`)){
    currentYear=ny;yearSel.value=ny;renderTable();}
}

function renderTable(){
  tbody.innerHTML='';
  const rows=getRows();

  rows.forEach(r=>{
    const tr=document.createElement('tr');tr.dataset.rowId=r.id;tr.className=r.type;
    tr.draggable=r.type==='item';

    const label=document.createElement('td');label.className='col-label';label.textContent=r.name;
    tr.appendChild(label);

    MONTHS.forEach((m,mi)=>{
      const td=document.createElement('td');
      if(r.type==='item'){
        const inp=document.createElement('input');inp.type='number';inp.step='0.01';
        const val=db[currentYear]?.[r.id]?.[mi]||0;
        inp.value=val?val.toFixed(2):'';
        inp.oninput=()=>debounce(()=>cellChanged(r.id,mi,inp.value));
        td.appendChild(inp);
      }
      tr.appendChild(td);
    });

    const ytd=document.createElement('td');ytd.className='yearTotal';tr.appendChild(ytd);
    tbody.appendChild(tr);

    tr.addEventListener('dragstart',dragStart);
    tr.addEventListener('dragover',dragOver);
    tr.addEventListener('drop',dropRow);
  });

  updateTotals();
  renderCharts();
}

let dragSrc=null;
function dragStart(e){dragSrc=this;e.dataTransfer.effectAllowed='move';}
function dragOver(e){e.preventDefault();}
function dropRow(e){e.preventDefault();if(this!==dragSrc){
  const rows=db.rows||[];
  const arr=rows;
  const i1=arr.findIndex(x=>x.id===dragSrc.dataset.rowId);
  const i2=arr.findIndex(x=>x.id===this.dataset.rowId);
  if(i1>-1 && i2>-1){
    const tmp=arr[i1];arr[i1]=arr[i2];arr[i2]=tmp;
    saveAll();renderTable();
  }
 }}

function debounce(fn){clearTimeout(debounceTimer);debounceTimer=setTimeout(fn,DEBOUNCE_DELAY);} 

function cellChanged(id,mi,val){
  let v=parseFloat(val);if(isNaN(v)||v<0)v=0;
  if(!db[currentYear])db[currentYear]={};
  if(!db[currentYear][id])db[currentYear][id]=Array(12).fill(0);
  db[currentYear][id][mi]=v;
  saveAll();updateTotals();renderCharts();
}

function updateTotals(){
  const rows=getRows();
  rows.forEach(r=>{
    if(r.type==='total'){
      if(!db[currentYear][r.id])db[currentYear][r.id]=Array(12).fill(0);
      let arr=Array(12).fill(0);
      r.totalOf.forEach(id=>{
        let vals=db[currentYear][id]||Array(12).fill(0);
        vals.forEach((v,i)=>arr[i]+=v);
      });
      db[currentYear][r.id]=arr;
    }
  });

  let netRow=rows.find(r=>r.type==='net');
  if(netRow){
    let inc=db[currentYear][netRow.netOf[0]]||Array(12).fill(0);
    let exp=db[currentYear][netRow.netOf[1]]||Array(12).fill(0);
    db[currentYear][netRow.id]=inc.map((v,i)=>v-exp[i]);
  }

  rows.forEach(r=>{
    if(['total','net'].includes(r.type)){
      const tr=tbody.querySelector(`tr[data-row-id="${r.id}"]`);
      if(!tr)return;
      const vals=db[currentYear][r.id]||Array(12).fill(0);
      vals.forEach((v,i)=>{
        const td=tr.children[i+1];td.textContent=v.toFixed(2);
        if(r.type==='net') td.className=v>=0?'net-pos':'net-neg';
      });
      const ytd=tr.querySelector('.yearTotal');
      const sum=vals.reduce((a,b)=>a+b,0);
      ytd.textContent=sum.toFixed(2);
      ytd.className=sum>=0?'net-pos':'net-neg';
    }
  });

  saveAll();
}

let incomeChart,expenseChart,netChart;
function renderCharts(){
  let inc=db[currentYear]['inc_total']||Array(12).fill(0);
  let exp=db[currentYear]['exp_total']||Array(12).fill(0);
  let net=db[currentYear]['net']||Array(12).fill(0);

  const ctx1=document.getElementById('incomeChart');
  const ctx2=document.getElementById('expenseChart');
  const ctx3=document.getElementById('netChart');

  if(incomeChart) incomeChart.destroy();
  if(expenseChart) expenseChart.destroy();
  if(netChart) netChart.destroy();

  incomeChart=new Chart(ctx1,{type:'line',data:{labels:MONTHS,datasets:[{label:'Income',data:inc}]} });
  expenseChart=new Chart(ctx2,{type:'line',data:{labels:MONTHS,datasets:[{label:'Expenses',data:exp}]} });
  netChart=new Chart(ctx3,{type:'bar',data:{labels:MONTHS,datasets:[{label:'Net',data:net}]} });
}

function exportCSV(){
  let d=db[currentYear]||{};
  let rows=getRows();
  let csv='Category,'+MONTHS.join(',')+',Year Total
';
  rows.forEach(r=>{
    let vals=d[r.id]||Array(12).fill(0);
    let row=[r.name,...vals.map(v=>v.toFixed(2)),vals.reduce((a,b)=>a+b,0).toFixed(2)];
    csv+=row.join(',')+'
';
  });

  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`budget_${currentYear}.csv`;a.click();
}

function handleImport(e){
  let file=e.target.files[0];if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const lines=ev.target.result.split('
').filter(l=>l.trim());
    lines.shift();
    let rows=getRows();
    if(!db[currentYear]) db[currentYear]={};

    lines.forEach((ln,i)=>{
      let cols=ln.split(',');if(cols.length<14)return;
      const r=rows[i];if(!r)return;
      db[currentYear][r.id]=cols.slice(1,13).map(v=>Math.max(0,parseFloat(v)||0));
    });
    saveAll();renderTable();importFile.value='';
  };
  reader.readAsText(file);
}

function saveAll(){localStorage.setItem(STORAGE_KEY,JSON.stringify(db));}
function loadAll(){return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');}

init();
</script>

</body>
</html>
